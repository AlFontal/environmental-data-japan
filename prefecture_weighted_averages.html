<!DOCTYPE html>
<html><head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Computing prefecture-wise weighted averages of Pollution data â€” Japan's Environmental Data</title>
    
  <link href="_static/css/theme.css" rel="stylesheet"/>
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet"/>

    
  <link href="_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>

    
      

    
    <link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" rel="stylesheet" type="text/css"/>
    <link href="_static/togglebutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/mystnb.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
    <link href="_static/custom.css" rel="stylesheet" type="text/css"/>
    <link href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" rel="stylesheet" type="text/css"/>
    <link href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" rel="stylesheet" type="text/css"/>
    
  <link as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js" rel="preload"/>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "AlFontal/environmental-data-japan");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link href="https://alfontal.github.io/environmental-data-japan/prefecture_weighted_averages.html" rel="canonical"/>
    <link href="_static/favicon.ico" rel="shortcut icon"/>
    <link href="genindex.html" rel="index" title="Index"/>
    <link href="search.html" rel="search" title="Search"/>
    <link href="index.html" rel="prev" title="Japanâ€™s environmental Data"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="None" name="docsearch:language"/>
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DC18W62KP8"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-DC18W62KP8');
                </script>

  </head>
  <body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img alt="logo" class="logo" src="_static/logo.png"/>
      
      
      <h1 class="site-logo" id="site-title">Japan's Environmental Data</h1>
      
    </a>
</div><form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="icon fas fa-search"></i>
  <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Japanâ€™s environmental Data
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   From station to prefectural data
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
<div>           
<hr/>
<a href="https://helical-itn.github.io/">
<img src="https://helical-itn.github.io/assets/institutional_logos/helical-logo.png" width="200px"/>
</a>
<p></p>
<a href="https://www.isglobal.org/en/-/clima-y-salud">
<img src="https://www.isglobal.org/isglobal-new-theme/assets/images/isglobal/logo-isglobal-en.png" width="200px"/>
</a>
<hr/>
<a href="https://www.linkedin.com/in/alfontal/">
<img alt="Alejandro Fontal" class="profile" src="https://avatars.githubusercontent.com/u/10958332?s=400&amp;u=51edd1406d2af0c2f1723a0bf8f111d48a1b7fe7&amp;v=4"/>
<p style="text-align: center; font-size:16px"><b>Alejandro Fontal</b></p>
</a>
<a class="fa fa-github" href="https://github.com/AlFontal" style="font-size: 25px;"></a>
<a class="fa fa-linkedin" href="https://www.linkedin.com/in/alfontal/" style="font-size: 25px;"></a>
<a class="fa fa-twitter" href="https://twitter.com/alefontal" style="font-size: 25px;"></a>
<a class="fa fa-envelope" href="mailto:alejandro.fontal.92@gmail.com" style="font-size: 25px;"></a>
</div>

</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" class="navbar-toggler ml-0" data-placement="bottom" data-target=".site-navigation" data-toggle="collapse" id="navbar-toggler" title="Toggle navigation" type="button">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button aria-label="Download this page" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/prefecture_weighted_averages.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Download source file" type="button">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" id="download-print" onclick="printPdf(this)" title="Print to PDF" type="button">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button aria-label="Connect with source repository" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button" href="https://github.com/AlFontal/environmental-data-japan"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Source repository" type="button"><i class="fab fa-github"></i>repository</button></a>
        <a class="issues-button" href="https://github.com/AlFontal/environmental-data-japan/issues/new?title=Issue%20on%20page%20%2Fprefecture_weighted_averages.html&amp;body=Your%20issue%20content%20here."><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Open an issue" type="button"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode" type="button"><i class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button aria-label="Launch interactive content" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/AlFontal/environmental-data-japan/main?urlpath=tree/prefecture_weighted_averages.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Launch Binder" type="button"><img alt="Interact on binder" class="binder-button-logo" src="_static/images/logo_binder.svg"/>Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav aria-label="Page" id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   Data Loading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-the-shapes">
     Fetching the shapes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-municipalities-populations">
     Fetching municipalities populations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matching-stations-municipalities-and-populations">
   Matching stations, municipalities, and populations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-municipal-estimates">
   Generating the daily averaged municipal estimates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-prefectural-estimates">
   Generating the daily averaged prefectural estimates
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#area-weighted-averages">
     Area-weighted averages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-population-of-children-under-5-years-old">
     Weighting by population of children under 5 years old
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-full-population-density">
     Weighting by full population density
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-the-data">
   Visualizing the data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stations-per-variable-per-prefecture">
     Number of stations per variable per prefecture
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimation-of-population-coverage-per-prefecture">
     Estimation of population coverage per prefecture
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#population-map">
       Population map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#stations-map">
       Stations map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#population-coverage-map">
       Population coverage map
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div class="row" id="main-content">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div class="onlyprint" id="jb-print-docs-body">
                <h1>Computing prefecture-wise weighted averages of Pollution data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   Data Loading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-the-shapes">
     Fetching the shapes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-municipalities-populations">
     Fetching municipalities populations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matching-stations-municipalities-and-populations">
   Matching stations, municipalities, and populations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-municipal-estimates">
   Generating the daily averaged municipal estimates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-prefectural-estimates">
   Generating the daily averaged prefectural estimates
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#area-weighted-averages">
     Area-weighted averages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-population-of-children-under-5-years-old">
     Weighting by population of children under 5 years old
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-full-population-density">
     Weighting by full population density
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-the-data">
   Visualizing the data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stations-per-variable-per-prefecture">
     Number of stations per variable per prefecture
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimation-of-population-coverage-per-prefecture">
     Estimation of population coverage per prefecture
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#population-map">
       Population map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#stations-map">
       Stations map
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#population-coverage-map">
       Population coverage map
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="computing-prefecture-wise-weighted-averages-of-pollution-data">
<h1>Computing prefecture-wise weighted averages of Pollution data<a class="headerlink" href="#computing-prefecture-wise-weighted-averages-of-pollution-data" title="Permalink to this headline">Â¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#preamble" id="id1">Preamble</a></p>
<ul>
<li><p><a class="reference internal" href="#imports" id="id2">Imports</a></p></li>
<li><p><a class="reference internal" href="#pre-sets" id="id3">Pre-sets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-loading" id="id4">Data Loading</a></p>
<ul>
<li><p><a class="reference internal" href="#fetching-the-shapes" id="id5">Fetching the shapes</a></p></li>
<li><p><a class="reference internal" href="#fetching-municipalities-populations" id="id6">Fetching municipalities populations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#matching-stations-municipalities-and-populations" id="id7">Matching stations, municipalities, and populations</a></p></li>
<li><p><a class="reference internal" href="#generating-the-daily-averaged-municipal-estimates" id="id8">Generating the daily averaged municipal estimates</a></p></li>
<li><p><a class="reference internal" href="#generating-the-daily-averaged-prefectural-estimates" id="id9">Generating the daily averaged prefectural estimates</a></p>
<ul>
<li><p><a class="reference internal" href="#area-weighted-averages" id="id10">Area-weighted averages</a></p></li>
<li><p><a class="reference internal" href="#weighting-by-population-of-children-under-5-years-old" id="id11">Weighting by population of children under 5 years old</a></p></li>
<li><p><a class="reference internal" href="#weighting-by-full-population-density" id="id12">Weighting by full population density</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#visualizing-the-data" id="id13">Visualizing the data</a></p>
<ul>
<li><p><a class="reference internal" href="#number-of-stations-per-variable-per-prefecture" id="id14">Number of stations per variable per prefecture</a></p></li>
<li><p><a class="reference internal" href="#estimation-of-population-coverage-per-prefecture" id="id15">Estimation of population coverage per prefecture</a></p>
<ul>
<li><p><a class="reference internal" href="#population-map" id="id16">Population map</a></p></li>
<li><p><a class="reference internal" href="#stations-map" id="id17">Stations map</a></p></li>
<li><p><a class="reference internal" href="#population-coverage-map" id="id18">Population coverage map</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="preamble">
<h2><a class="toc-backref" href="#id1">Preamble</a><a class="headerlink" href="#preamble" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="imports">
<h3><a class="toc-backref" href="#id2">Imports</a><a class="headerlink" href="#imports" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os
import requests

import numpy as np
import pandas as pd
import plotnine as p9
import geopandas as gpd
import matplotlib as mpl
import matplotlib.pyplot as plt

from tqdm import tqdm
from IPython.display import Image
from collections import defaultdict
from shapely.geometry import box, Point
from mizani.formatters import date_format, percent_format, custom_format
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pre-sets">
<h3><a class="toc-backref" href="#id3">Pre-sets</a><a class="headerlink" href="#pre-sets" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tqdm.pandas()
p9.options.set_option('dpi', 600)
p9.options.set_option('figure_size', (4, 3))
p9.options.set_option('base_family', 'Georgia')
p9.theme_set(p9.theme_bw() + p9.theme(axis_text=p9.element_text(size=7),
                                      axis_title=p9.element_text(size=9),
                                      title=p9.element_text(size=11)))
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="data-loading">
<h2><a class="toc-backref" href="#id4">Data Loading</a><a class="headerlink" href="#data-loading" title="Permalink to this headline">Â¶</a></h2>
<p>With daily data of the monitoring stations already collected, we are now going to collect two different sources of information that
should enable us to compute population weighted averages of the station data per prefecture. The files will be the following:</p>
<ul class="simple">
<li><p>Population density per municipality in Japan</p></li>
<li><p>Shapefiles of the said municipalities so as to be able to match the location of the monitoring station to a certain number of population</p></li>
</ul>
<div class="section" id="fetching-the-shapes">
<h3><a class="toc-backref" href="#id5">Fetching the shapes</a><a class="headerlink" href="#fetching-the-shapes" title="Permalink to this headline">Â¶</a></h3>
<p>While several sources of shapefiles ara available online, I could not find any that included the same municipal codes that would enable a match with the population data obtained from the <a class="reference external" href="https://www.e-stat.go.jp">official Japanese statistics site</a>.</p>
<p>This site, however, also provides a very precise collection of shapefiles for each of the 47 prefectures, with areas smaller than the municipal level (the one we are interested in), but with municipal-level identifiers, so we can <em>fuse</em> the shapes to obtain exactly the shapes for all municipalities in Japan.</p>
<p>Letâ€™s do exactly that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def get_download_url(code):
    url = 'https://www.e-stat.go.jp/gis/statmap-search/data?dlserveyId=A002005212015' \
         f'&amp;code={code}&amp;coordSys=1&amp;format=shape&amp;downloadType=5&amp;datum=2000'
    return url
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>shapes_path = '../data/shapefiles/administrative_boundaries'
if not os.path.exists(f'{shapes_path}/municipality_shapes.shp'):
    municipality_shapes = []
    for i in tqdm(range(1, 48), total=47):
        municipality_shapes.append(
            gpd.read_file(get_download_url(str(i).zfill(2))).dissolve(by='CITY')
        )

    municipality_shapes = pd.concat(municipality_shapes).reset_index()[['PREF', 'CITY', 'geometry']]
    prefecture_shapes = municipality_shapes.dissolve(by='PREF').reset_index()[['PREF', 'geometry']]
    municipality_shapes.to_file(f'{shapes_path}/municipality_shapes.shp')
    prefecture_shapes.to_file(f'{shapes_path}/prefecture_shapes.shp')
else:
    municipality_shapes = gpd.read_file(f'{shapes_path}/municipality_shapes.shp')
    prefecture_shapes = gpd.read_file(f'{shapes_path}/prefecture_shapes.shp')
</pre></div>
</div>
</div>
</div>
<p>We now have the equivalent shapefiles grouped at the <strong>municipal</strong> and the <strong>prefectural</strong> level, leading to a map of Japan like the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(p9.ggplot(municipality_shapes) 
    + p9.geom_map(alpha=.2, size=.05, color='gray')
    + p9.geom_map(data=prefecture_shapes, size=.15, alpha=0)
    + p9.scale_y_continuous(labels=custom_format('{:0g}Â°N'), limits=(30, 45))
    + p9.scale_x_continuous(labels=custom_format('{:0g}Â°E'), limits=(129, 145.5))
    + p9.theme(figure_size=(2.5, 2.5),
               axis_text=p9.element_text(size=5),
               panel_grid=p9.element_blank())
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_14_0.png" src="_images/prefecture_weighted_averages_14_0.png"/>

</div>
</div>
</div>
<div class="section" id="fetching-municipalities-populations">
<h3><a class="toc-backref" href="#id6">Fetching municipalities populations</a><a class="headerlink" href="#fetching-municipalities-populations" title="Permalink to this headline">Â¶</a></h3>
<p>The same Statistics portal that we used to fetch the shapefiles provides an API to fetch different variables recorded by the government. It is necessary to register in the system to obtain an identifier that accompanies the requests to the API in order to be granted access. The documentation to use the API can be found <a class="reference external" href="https://www.e-stat.go.jp/api/api-dev/how_to_use">here</a> (itâ€™s all in Japanese but itâ€™s manageable with Google translate).</p>
<p>Weâ€™ll start by defining the API URL preceding the parameters specifying the version of the API we will be using (3.0) and the output we want (json):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>API_URL = 'http://api.e-stat.go.jp/rest/3.0/app/json/getStatsData'
</pre></div>
</div>
</div>
</div>
<p>I have already checked the variables I am interested in, although there are plenty more to choose. We will be fetching the following codes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_api_codes = {'A1101': 'Total population (Both sexes)',
                'A110101': 'Total population (Male)',
                'A110102': 'Total population (Female)',
                'A1301': 'Total population (under 15)',
                'A130101': 'Population (under 15, Male)',
                'A130102': 'Population (under 15, Female)',
                'A1302': 'Total population (15-64)',
                'A130201': 'Population (15-64, Male)',
                'A130202': 'Population (15-64, Female)',
                'A1303': 'Total population (65 and over)',
                'A130301': 'Population (65 and over, Male)',
                'A130302': 'Population (65 and over, Female)',
                'A1405': 'Population (0-5, Total)',
                'A140501': 'Population (0-5, Male)',
                'A140502': 'Population (0-5, Female)',
                'A1416': 'Population (60 and over, Total)',
                'A141601': 'Population (60 and over, Male)',
                'A141602': 'Population (60 and over, Female)',
                'A1417': 'Population (70 and over, Total)',
                'A141701': 'Population (70 and over, Male)',
                'A141702': 'Population (70 and over, Female)',
                'A1420': 'Population (85 and over, Total)',
                'A142001': 'Population (85 and over, Male)',
                'A142002': 'Population (85 and over, Female)'
               }
</pre></div>
</div>
</div>
</div>
<p>I have saved my personal <code class="docutils literal notranslate"><span class="pre">appID</span></code> in a non-shared file in the root folder as <code class="docutils literal notranslate"><span class="pre">.appID</span></code>. Letâ€™s read it so as to include it in the request URL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>with open('../.appID', 'r') as fh:
    API_ID = fh.read()
</pre></div>
</div>
</div>
</div>
<p>We need to URL encode all the variables in the requests, which should be done by joining them with the <code class="docutils literal notranslate"><span class="pre">%2C</span></code> characters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>variables_string = '%2C'.join(list(jp_api_codes.keys()))
</pre></div>
</div>
</div>
</div>
<p>The full request will be the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>url = (f'{API_URL}'                       # Main API URL
       f'?cdCat01={variables_string}'     # Specify the variables selected
       f'&amp;appId={API_ID}'                 # Add the API ID to be allowed access 
        '&amp;lang=E'                         # Specify the language to be English
        '&amp;statsDataId=0000020201'         # Specify the dataset to be used
        '&amp;cdTimeFrom=2015')               # Request data from the last census (2015)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>r = requests.get(url)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>full_population_df = (pd.DataFrame(r.json()
                      ['GET_STATS_DATA']['STATISTICAL_DATA']['DATA_INF']['VALUE'])
                      .loc[lambda dd: dd['@time'].str.startswith('2015')]
                      .drop(columns=['@tab', '@time', '@unit'])
                      .rename(columns={'@area': 'area_code'})
                      .pivot('area_code', '@cat01', '$')
                      .rename(columns=jp_api_codes)
)
</pre></div>
</div>
</div>
</div>
<p>I will keep an already processed version of this dataset in the repository as an easily accessible CSV table to ease future usage of the files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>full_population_df.to_csv('../data/population/municipal_population_stats.csv')
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>full_population_df = pd.read_csv('../data/population/municipal_population_stats.csv')
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="matching-stations-municipalities-and-populations">
<h2><a class="toc-backref" href="#id7">Matching stations, municipalities, and populations</a><a class="headerlink" href="#matching-stations-municipalities-and-populations" title="Permalink to this headline">Â¶</a></h2>
<p>Since my main interest lies on relating the environmental variables to Kawasaki Disease incidence in Japan, I am going to use the municipal population of children under 5 years old to weight the importance of each municipal term in the prefecture averages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_pops_kids = (full_population_df
                .reset_index()
                .rename(columns={'area_code': 'code'})
                .assign(code=lambda dd: dd.code.astype(str).str.zfill(5))
                .assign(population=lambda dd: dd['Population (0-5, Total)'].astype(int))
                [['code', 'population']]
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_pops_full = (full_population_df
                .reset_index()
                .rename(columns={'area_code': 'code'})
                .assign(code=lambda dd: dd.code.astype(str).str.zfill(5))
                .assign(population=lambda dd: dd['Total population (Both sexes)'].astype(int))
                [['code', 'population']]
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_munis = (municipality_shapes
            .reset_index()
            .assign(code=lambda dd: dd.PREF + dd.CITY.astype(str))
            [['PREF', 'CITY', 'code', 'geometry']]
            )
</pre></div>
</div>
</div>
</div>
<p>We can now load the monitoring stations information, and use their coordinates to assign a municipal boundary to each of them. This way, we will be able to average a value for each municipality using the values of the monitoring stations within its boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>monitoring_stations = (pd.read_csv('../data/air_pollution/stations/doc/stations_info.csv')
                       .assign(geometry=lambda dd: [Point(np.array([x, y])) 
                                                     for x, y in zip(dd.longitude, dd.latitude)])
                       .pipe(lambda dd: gpd.GeoDataFrame(dd, geometry='geometry', crs='EPSG:4612'))
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>station_munis = (gpd.sjoin(monitoring_stations, jp_munis, predicate='within')
                 .merge(jp_munis[['code', 'geometry']].rename(columns={'geometry': 'm_polygon'}))
                )
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>stations_per_city = station_munis.groupby(['PREF', 'CITY']).station_code.unique()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>prefectures_map = (monitoring_stations
                    [['prefecture', 'prefecture_code']]
                    .drop_duplicates()
                    .set_index('prefecture_code')
                    ['prefecture']
                    .to_dict()
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generating-the-daily-averaged-municipal-estimates">
<h2><a class="toc-backref" href="#id8">Generating the daily averaged municipal estimates</a><a class="headerlink" href="#generating-the-daily-averaged-municipal-estimates" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>municipal_pollution_dfs = []
for (pref, city), stations in tqdm(stations_per_city.items(), total=len(stations_per_city)):
    municipal_stations = []
    pref_name = prefectures_map[int(pref)]
    for station in stations:
        municipal_stations.append(
        pd.read_csv(f'../data/air_pollution/stations/clean/{pref}_{pref_name}/{station}.csv')
                    .assign(date=lambda dd: pd.to_datetime(dd.date))
        )
    
    municipal_stations = (pd.concat(municipal_stations)
                          .set_index('date')
                          .resample('D')
                          .mean())
    municipal_pollution_dfs.append(municipal_stations.assign(pref=pref, city=city))
    municipal_stations.round(3).to_csv(f'../data/air_pollution/municipalities/{pref}{city}.csv')
municipal_pollution_dfs = pd.concat(municipal_pollution_dfs)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 905/905 [00:07&lt;00:00, 128.60it/s]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generating-the-daily-averaged-prefectural-estimates">
<h2><a class="toc-backref" href="#id9">Generating the daily averaged prefectural estimates</a><a class="headerlink" href="#generating-the-daily-averaged-prefectural-estimates" title="Permalink to this headline">Â¶</a></h2>
<p>Now, by using the municipal values and weighting them by different factors, we will be able to obtain prefecture-level estimates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>long_pollution_df = (municipal_pollution_dfs
                     .reset_index()
                     .melt(['date', 'pref', 'city'])
                     .dropna()
                     .eval('code = pref + city')
)
</pre></div>
</div>
</div>
</div>
<div class="section" id="area-weighted-averages">
<h3><a class="toc-backref" href="#id10">Area-weighted averages</a><a class="headerlink" href="#area-weighted-averages" title="Permalink to this headline">Â¶</a></h3>
<p>The first prefectural estimates we will estimate will be population agnostic, that is, each municipality will have a weight proportional to its area:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_areas = (jp_munis
            .eval('area = geometry.to_crs("+proj=cea").area / 10**6')
            [['code', 'area']]
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for prefecture, df in long_pollution_df.groupby('pref'):
    pref_df = (df.groupby(['date', 'variable'])
                 .progress_apply(lambda df: df
                                        .merge(jp_areas)
                                        .eval('weight = area / area.sum()')
                                        .eval('value = value * weight')
                                        .value.sum())
                 .rename('value')
                 .reset_index()
                 .pivot(index='date', columns='variable', values='value')
)
    pref_df.round(3).to_csv(f'../data/air_pollution/prefectures/area_weighted/{prefecture}.csv')
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="weighting-by-population-of-children-under-5-years-old">
<h3><a class="toc-backref" href="#id11">Weighting by population of children under 5 years old</a><a class="headerlink" href="#weighting-by-population-of-children-under-5-years-old" title="Permalink to this headline">Â¶</a></h3>
<p>In this case we will weigh its municipality proportional to the relative amount of children under 5 years old living in it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for prefecture, df in long_pollution_df.groupby('pref'):
    pref_df = (df.groupby(['date', 'variable'])
                 .progress_apply(lambda df: df
                                        .merge(jp_pops_kids)
                                        .eval('weight = population / population.sum()')
                                        .eval('value = value * weight')
                                        .value.sum())
                 .rename('value')
                 .reset_index()
                 .pivot(index='date', columns='variable', values='value')
)
    pref_df.round(3).to_csv(f'../data/air_pollution/prefectures/under_5_weighted/{prefecture}.csv')
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="weighting-by-full-population-density">
<h3><a class="toc-backref" href="#id12">Weighting by full population density</a><a class="headerlink" href="#weighting-by-full-population-density" title="Permalink to this headline">Â¶</a></h3>
<p>In the last case, we will weigh each municipality proportional to the total population living in each term.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for prefecture, df in long_pollution_df.groupby('pref'):
    pref_df = (df.groupby(['date', 'variable'])
                 .progress_apply(lambda df: df
                                        .merge(jp_pops_full)
                                        .eval('weight = population / population.sum()')
                                        .eval('value = value * weight')
                                        .value.sum())
                 .rename('value')
                 .reset_index()
                 .pivot(index='date', columns='variable', values='value')
)
    pref_df.round(3).to_csv(f'../data/air_pollution/prefectures/population_weighted/{prefecture}.csv')
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="visualizing-the-data">
<h2><a class="toc-backref" href="#id13">Visualizing the data</a><a class="headerlink" href="#visualizing-the-data" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="number-of-stations-per-variable-per-prefecture">
<h3><a class="toc-backref" href="#id14">Number of stations per variable per prefecture</a><a class="headerlink" href="#number-of-stations-per-variable-per-prefecture" title="Permalink to this headline">Â¶</a></h3>
<p>While there are many stations, not all variables are measured with the same consistency. The following table shows how many stations measure each variable in each prefecture:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>variable_map = {'NOX': 'NO$_{x}$',
                'PM25': 'PM$_{2.5}$',
                'SO2': 'SO$_2$',
                'CO2': 'CO$_2$',
                'SPM': 'PM$_{10}$'}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(monitoring_stations
 .drop(columns=['station_code', 'latitude', 'longitude', 'altitude'])
 .groupby(['prefecture', 'prefecture_code'])
 .sum(numeric_only=True)
 .astype(int)
 .sort_values('prefecture_code')
 .apply(lambda x: x / monitoring_stations.groupby('prefecture_code').station_code.nunique())
 .applymap(lambda x: round(x * 100, 2))
 .reset_index()
 .melt(['prefecture', 'prefecture_code'])
 .query('not variable.isin(["NO", "NO2", "CH4", "NMHC"])')
 .replace(variable_map)
 .merge(monitoring_stations
        .groupby('prefecture_code')
        .station_code
        .nunique()
        .rename('n_stations')
        .reset_index())
 .assign(pref_name=lambda dd: dd.prefecture.str.split('-').str[0] + 
                                ' (' + dd.n_stations.astype(str) + ')')
 .pipe(lambda dd: p9.ggplot(dd) 
                + p9.aes(x='reorder(variable, value, ascending=True)',
                         y='reorder(pref_name, value, ascending=False)',
                         fill='value') 
                + p9.geom_tile(color='black')
                + p9.geom_text(p9.aes(label='value.round(0).astype(int)', color='value &gt; 70'), size=2.5)      
                + p9.theme_minimal()
                + p9.scale_color_manual(values=['black', 'white'])
                + p9.scale_fill_continuous('Oranges')
                + p9.guides(fill=False, color=False)
                + p9.labs(x='', y='', title='Percentage of stations collecting data')
                + p9.coord_flip()
                + p9.theme(figure_size=(4, 1.25),
                           title=p9.element_text(size=8),
                           axis_text_x=p9.element_text(angle=90, size=3.5, margin={'t': -10}),
                           axis_text_y=p9.element_text(size=4, ha='right', margin={'r': -10}),
                           panel_grid=p9.element_blank())
)
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_61_0.png" src="_images/prefecture_weighted_averages_61_0.png"/>

</div>
</div>
<p>Only NOx, SPM (or PM10), SO2 and PM2.5 are variables measured by over 50% of all stations, the rest are present in smaller numbers, which might limit the accuracy of the prefecture-level estimates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(monitoring_stations
 .drop(columns=['station_code', 'latitude', 'longitude', 'altitude'])
 .groupby(['prefecture', 'prefecture_code'])
 .sum(numeric_only=True)
 .astype(int)
 .sum()
 .pipe(lambda x: x / monitoring_stations.station_code.nunique())
 .rename('ratio')
 .reset_index()
 .query('not index.isin(["NO", "NO2", "CH4", "NMHC"])')
 .replace(variable_map)
 .pipe(lambda dd: p9.ggplot(dd) 
                + p9.aes('reorder(index, ratio)', 'ratio') 
                + p9.geom_col() 
                + p9.coord_flip()
                + p9.labs(x='', y='')
                + p9.scale_y_continuous(labels=percent_format()) 
                + p9.theme(figure_size=(2, 1.5),
                           axis_text=p9.element_text(size=4),
                           panel_grid=p9.element_blank())
 )
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_63_0.png" src="_images/prefecture_weighted_averages_63_0.png"/>

</div>
</div>
</div>
<div class="section" id="estimation-of-population-coverage-per-prefecture">
<h3><a class="toc-backref" href="#id15">Estimation of population coverage per prefecture</a><a class="headerlink" href="#estimation-of-population-coverage-per-prefecture" title="Permalink to this headline">Â¶</a></h3>
<p>We will apply a quite naÃ¯ve (and probably conservative) method to estimate the percentage of population â€˜coveredâ€™ by
monitoring stations: the % of population in a municipality with at least a station. The population living in
municipalities without any station will be considered as <em>uncovered</em> by this metric (which might be a tad unfair as
municipal terms can often be really small).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_munis = jp_munis.assign(has_station=lambda dd: dd.code.isin(station_munis.code))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pop_coverage = (jp_munis
                .merge(jp_pops_full)
                .groupby('PREF')
                .apply(lambda dd: dd.query('has_station').population.sum() / dd.population.sum())
                .rename('pop_coverage')
                .reset_index()
                .set_index('PREF')
)
</pre></div>
</div>
</div>
</div>
<p>The prefecture of Tokyo has many small islands (barely inhabited) which distort completely the shape of the region. Letâ€™s get ride of those for the plots:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>jp_munis = pd.concat([jp_munis.query("PREF!='13'"),
                      jp_munis.query("PREF=='13'")
                              .query('geometry.bounds.miny &gt; 35')])
</pre></div>
</div>
</div>
</div>
<div class="section" id="population-map">
<h4><a class="toc-backref" href="#id16">Population map</a><a class="headerlink" href="#population-map" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(p9.ggplot(jp_munis.merge(jp_pops_full))
+ p9.geom_map(p9.aes(fill='population'), size=.01) 
+ p9.geom_map(data=prefecture_shapes, size=.05, alpha=0)
+ p9.scale_fill_continuous('Oranges', breaks=[0, 250_000, 500_000, 750_000], labels=['0', '250k', '500k', '750k'])
+ p9.scale_y_continuous(labels=custom_format('{:0g}Â°N'), limits=(30, 45))
+ p9.scale_x_continuous(labels=custom_format('{:0g}Â°E'), limits=(129, 145.5))
+ p9.theme_void()
+ p9.labs(fill='Population (n)')
+ p9.theme(figure_size=(3, 3),
           legend_key_size=5,
           legend_position=(.35, .75),
           legend_direction='vertical',
           legend_title=p9.element_text(size=6),
           legend_text=p9.element_text(size=4, va='baseline'),)
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_71_0.png" src="_images/prefecture_weighted_averages_71_0.png"/>

</div>
</div>
</div>
<div class="section" id="stations-map">
<h4><a class="toc-backref" href="#id17">Stations map</a><a class="headerlink" href="#stations-map" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f = (p9.ggplot(jp_munis) 
    + p9.geom_map(size=.01, fill='white') 
    + p9.geom_map(data=prefecture_shapes, size=.05, alpha=0)
    + p9.geom_point(p9.aes(x='longitude', y='latitude'), data=monitoring_stations, size=.3, stroke=0, alpha=.7, color='red')
    + p9.scale_y_continuous(limits=(30, 45))
    + p9.scale_x_continuous(limits=(129, 145.5))
    + p9.guides(fill=False)
    + p9.theme_void()
    + p9.theme(figure_size=(3, 3),
               dpi=600)
).draw()

f.savefig('../data/air_pollution/stations/doc/stations_map.png')
f
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/prefecture_weighted_averages_73_1.png" src="_images/prefecture_weighted_averages_73_1.png"/>
</div>
</div>
</div>
<div class="section" id="population-coverage-map">
<h4><a class="toc-backref" href="#id18">Population coverage map</a><a class="headerlink" href="#population-coverage-map" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>stats_df = defaultdict(list)
for i in range(1, 48):
    shape = jp_munis.query(f'PREF=="{str(i).zfill(2)}"')
    stations = monitoring_stations.query(f'prefecture_code=={i}')
    stats_df['prefecture'].append(prefectures_map[i].split('-')[0])
    stats_df['prefecture_code'].append(i)
    stats_df['n_stations'].append(len(stations))
    stats_df['coverage'].append((pop_coverage.loc[str(i).zfill(2)] * 100).round(2).values[0])
    bounds = shape.bounds.agg(['min', 'max']).values
    stats_df['ar'].append((bounds[1, 3] - bounds[0, 1]) / (bounds[1, 2] - bounds[0, 0]))
stats_df = pd.DataFrame(stats_df)
</pre></div>
</div>
</div>
</div>
<p>To actually visualize the prefecture by prefecture population coverage, I generated a figure for each prefecture which was
later on merged together in a single figure with Inkscape. Notice how in most cases, stations and population go together, as most of the <em>stationless</em> municipalities are usually those which are also lowly populated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
for i in tqdm(stats_df.sort_values('ar').prefecture_code):
    shape = jp_munis.query(f'PREF=="{str(i).zfill(2)}"')
    stations = monitoring_stations.query(f'prefecture_code=={i}')
    n_stations = len(stations)
    prefecture_name = prefectures_map[i].split('-')[0]
    coverage = (pop_coverage.loc[str(i).zfill(2)] * 100).round(2).values[0]
    bounds = shape.bounds.agg(['min', 'max']).values
    ar = (bounds[1, 3] - bounds[0, 1]) / (bounds[1, 2] - bounds[0, 0])
    f = (p9.ggplot(shape) 
                + p9.geom_map(p9.aes(fill='population'), size=.02) 
                + p9.geom_point(p9.aes(x='longitude', y='latitude'),
                                data=stations, size=.3, stroke=0)
                + p9.labs(x='', y='', fill='')
                + p9.guides(fill=False)
                + p9.scale_fill_continuous('Oranges')
                + p9.ggtitle(f'{prefecture_name} ({n_stations}, {coverage}%)')
                + p9.theme_void()
                + p9.theme(aspect_ratio=ar,
                           figure_size=(1, 1),
                           dpi=1000,
                           title=p9.element_text(size=4),)

 ).save(f'../data/doc/images/{str(i).zfill(2)}_{prefecture_name}.pdf', bbox_inches='tight', verbose=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 47/47 [00:27&lt;00:00,  1.74it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>Image('../data/doc/images/prefectures_vertical.png')
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_78_0.png" src="_images/prefecture_weighted_averages_78_0.png"/>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class="prev-next-area"> 
    <a class="left-prev" href="index.html" id="prev-link" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Japanâ€™s environmental Data</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Alejandro Fontal<br/>
    
        Â© Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  
</body></html>