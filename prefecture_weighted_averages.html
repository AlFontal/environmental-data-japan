<!DOCTYPE html>
<html><head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Computing prefecture-wise weighted averages of Pollution data â€” Japan's Environmental Data</title>
    
  <link href="_static/css/theme.css" rel="stylesheet"/>
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet"/>

    
  <link href="_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>

    
      

    
    <link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" rel="stylesheet" type="text/css"/>
    <link href="_static/togglebutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/mystnb.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
    <link href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" rel="stylesheet" type="text/css"/>
    <link href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" rel="stylesheet" type="text/css"/>
    
  <link as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js" rel="preload"/>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "AlFontal/environmental-data-japan");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link href="https://alfontal.github.io/environmental-data-japan/prefecture_weighted_averages.html" rel="canonical"/>
    <link href="_static/favicon.ico" rel="shortcut icon"/>
    <link href="genindex.html" rel="index" title="Index"/>
    <link href="search.html" rel="search" title="Search"/>
    <link href="index.html" rel="prev" title="Japanâ€™s environmental Data"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="None" name="docsearch:language"/>
    

    <!-- Google Analytics -->
    
  </head>
  <body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img alt="logo" class="logo" src="_static/logo.png"/>
      
      
      <h1 class="site-logo" id="site-title">Japan's Environmental Data</h1>
      
    </a>
</div><form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="icon fas fa-search"></i>
  <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Japanâ€™s environmental Data
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   From station to prefectural data
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
<div>           
<hr/>
<a href="https://helical-itn.eu/">
<img src="https://helical-itn.eu/wp-content/uploads/2020/01/cropped-HELICAL_logo-3.png" width="200px"/>
</a>
<p></p>
<a href="https://www.isglobal.org/en/-/clima-y-salud">
<img src="https://www.isglobal.org/isglobal-new-theme/assets/images/isglobal/logo-isglobal-en.png" width="200px"/>
</a>
<hr/>
<a href="https://www.linkedin.com/in/alfontal/">
<img alt="Alejandro Fontal" class="profile" src="https://avatars.githubusercontent.com/u/10958332?s=400&amp;u=51edd1406d2af0c2f1723a0bf8f111d48a1b7fe7&amp;v=4"/>
<p style="text-align: center; font-size:16px"><b>Alejandro Fontal</b></p>
</a>
<a class="fa fa-github" href="https://github.com/AlFontal" style="font-size: 25px;"></a>
<a class="fa fa-linkedin" href="https://www.linkedin.com/in/alfontal/" style="font-size: 25px;"></a>
<a class="fa fa-twitter" href="https://twitter.com/alefontal" style="font-size: 25px;"></a>
<a class="fa fa-envelope" href="mailto:alejandro.fontal.92@gmail.com" style="font-size: 25px;"></a>
</div>

</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" class="navbar-toggler ml-0" data-placement="bottom" data-target=".site-navigation" data-toggle="collapse" id="navbar-toggler" title="Toggle navigation" type="button">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button aria-label="Download this page" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/prefecture_weighted_averages.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Download source file" type="button">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" id="download-print" onclick="printPdf(this)" title="Print to PDF" type="button">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button aria-label="Connect with source repository" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button" href="https://github.com/AlFontal/environmental-data-japan"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Source repository" type="button"><i class="fab fa-github"></i>repository</button></a>
        <a class="issues-button" href="https://github.com/AlFontal/environmental-data-japan/issues/new?title=Issue%20on%20page%20%2Fprefecture_weighted_averages.html&amp;body=Your%20issue%20content%20here."><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Open an issue" type="button"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode" type="button"><i class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button aria-label="Launch interactive content" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/AlFontal/environmental-data-japan/main?urlpath=tree/prefecture_weighted_averages.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Launch Binder" type="button"><img alt="Interact on binder" class="binder-button-logo" src="_static/images/logo_binder.svg"/>Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav aria-label="Page" id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   Data Loading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-the-shapes">
     Fetching the shapes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-municipalities-populations">
     Fetching municipalities populations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matching-stations-municipalities-and-populations">
   Matching stations, municipalities, and populations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-municipal-estimates">
   Generating the daily averaged municipal estimates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-prefectural-estimates">
   Generating the daily averaged prefectural estimates
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#area-weighted-averages">
     Area-weighted averages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-population-of-children-under-5-years-old">
     Weighting by population of children under 5 years old
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-full-population-density">
     Weighting by full population density
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-coverage-of-the-data">
   Visualizing coverage of the data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stations-per-variable-per-prefecture">
     Number of stations per variable per prefecture
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div class="row" id="main-content">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div class="onlyprint" id="jb-print-docs-body">
                <h1>Computing prefecture-wise weighted averages of Pollution data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   Data Loading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-the-shapes">
     Fetching the shapes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-municipalities-populations">
     Fetching municipalities populations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matching-stations-municipalities-and-populations">
   Matching stations, municipalities, and populations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-municipal-estimates">
   Generating the daily averaged municipal estimates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generating-the-daily-averaged-prefectural-estimates">
   Generating the daily averaged prefectural estimates
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#area-weighted-averages">
     Area-weighted averages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-population-of-children-under-5-years-old">
     Weighting by population of children under 5 years old
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighting-by-full-population-density">
     Weighting by full population density
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualizing-coverage-of-the-data">
   Visualizing coverage of the data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#number-of-stations-per-variable-per-prefecture">
     Number of stations per variable per prefecture
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="computing-prefecture-wise-weighted-averages-of-pollution-data">
<h1>Computing prefecture-wise weighted averages of Pollution data<a class="headerlink" href="#computing-prefecture-wise-weighted-averages-of-pollution-data" title="Permalink to this headline">Â¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#preamble" id="id1">Preamble</a></p>
<ul>
<li><p><a class="reference internal" href="#imports" id="id2">Imports</a></p></li>
<li><p><a class="reference internal" href="#pre-sets" id="id3">Pre-sets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-loading" id="id4">Data Loading</a></p>
<ul>
<li><p><a class="reference internal" href="#fetching-the-shapes" id="id5">Fetching the shapes</a></p></li>
<li><p><a class="reference internal" href="#fetching-municipalities-populations" id="id6">Fetching municipalities populations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#matching-stations-municipalities-and-populations" id="id7">Matching stations, municipalities, and populations</a></p></li>
<li><p><a class="reference internal" href="#generating-the-daily-averaged-municipal-estimates" id="id8">Generating the daily averaged municipal estimates</a></p></li>
<li><p><a class="reference internal" href="#generating-the-daily-averaged-prefectural-estimates" id="id9">Generating the daily averaged prefectural estimates</a></p>
<ul>
<li><p><a class="reference internal" href="#area-weighted-averages" id="id10">Area-weighted averages</a></p></li>
<li><p><a class="reference internal" href="#weighting-by-population-of-children-under-5-years-old" id="id11">Weighting by population of children under 5 years old</a></p></li>
<li><p><a class="reference internal" href="#weighting-by-full-population-density" id="id12">Weighting by full population density</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#visualizing-coverage-of-the-data" id="id13">Visualizing coverage of the data</a></p>
<ul>
<li><p><a class="reference internal" href="#number-of-stations-per-variable-per-prefecture" id="id14">Number of stations per variable per prefecture</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="preamble">
<h2><a class="toc-backref" href="#id1">Preamble</a><a class="headerlink" href="#preamble" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="imports">
<h3><a class="toc-backref" href="#id2">Imports</a><a class="headerlink" href="#imports" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotnine</span> <span class="k">as</span> <span class="nn">p9</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">mizani.formatters</span> <span class="kn">import</span> <span class="n">date_format</span><span class="p">,</span> <span class="n">percent_format</span><span class="p">,</span> <span class="n">custom_format</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pre-sets">
<h3><a class="toc-backref" href="#id3">Pre-sets</a><a class="headerlink" href="#pre-sets" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">()</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'dpi'</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'figure_size'</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'base_family'</span><span class="p">,</span> <span class="s1">'Bitstream Vera Serif'</span><span class="p">)</span>
<span class="n">p9</span><span class="o">.</span><span class="n">theme_set</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">theme_bw</span><span class="p">()</span> <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                                      <span class="n">axis_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
                                      <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="data-loading">
<h2><a class="toc-backref" href="#id4">Data Loading</a><a class="headerlink" href="#data-loading" title="Permalink to this headline">Â¶</a></h2>
<p>With daily data of the monitoring stations already collected, we are now going to collect two different sources of information that
should enable us to compute population weighted averages of the station data per prefecture. The files will be the following:</p>
<ul class="simple">
<li><p>Population density per municipality in Japan</p></li>
<li><p>Shapefiles of the said municipalities so as to be able to match the location of the monitoring station to a certain number of population</p></li>
</ul>
<div class="section" id="fetching-the-shapes">
<h3><a class="toc-backref" href="#id5">Fetching the shapes</a><a class="headerlink" href="#fetching-the-shapes" title="Permalink to this headline">Â¶</a></h3>
<p>While several sources of shapefiles ara available online, I could not find any that included the same municipal codes that would enable a match with the population data obtained from the <a class="reference external" href="https://www.e-stat.go.jp">official Japanese statistics site</a>.</p>
<p>This site, however, also provides a very precise collection of shapefiles for each of the 47 prefectures, with areas smaller than the municipal level (the one we are interested in), but with municipal-level identifiers, so we can <em>fuse</em> the shapes to obtain exactly the shapes for all municipalities in Japan.</p>
<p>Letâ€™s do exactly that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_download_url</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">'https://www.e-stat.go.jp/gis/statmap-search/data?dlserveyId=A002005212015'</span> \
         <span class="sa">f</span><span class="s1">'&amp;code=</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">&amp;coordSys=1&amp;format=shape&amp;downloadType=5&amp;datum=2000'</span>
    <span class="k">return</span> <span class="n">url</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shapes_path</span> <span class="o">=</span> <span class="s1">'../data/shapefiles/administrative_boundaries'</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">shapes_path</span><span class="si">}</span><span class="s1">/municipality_shapes.shp'</span><span class="p">):</span>
    <span class="n">municipality_shapes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">48</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="mi">47</span><span class="p">):</span>
        <span class="n">municipality_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_download_url</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'CITY'</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">municipality_shapes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">municipality_shapes</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">'PREF'</span><span class="p">,</span> <span class="s1">'CITY'</span><span class="p">,</span> <span class="s1">'geometry'</span><span class="p">]]</span>
    <span class="n">prefecture_shapes</span> <span class="o">=</span> <span class="n">municipality_shapes</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'PREF'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">'PREF'</span><span class="p">,</span> <span class="s1">'geometry'</span><span class="p">]]</span>
    <span class="n">municipality_shapes</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">shapes_path</span><span class="si">}</span><span class="s1">/municipality_shapes.shp'</span><span class="p">)</span>
    <span class="n">prefecture_shapes</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">shapes_path</span><span class="si">}</span><span class="s1">/prefecture_shapes.shp'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">municipality_shapes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">shapes_path</span><span class="si">}</span><span class="s1">/municipality_shapes.shp'</span><span class="p">)</span>
    <span class="n">prefecture_shapes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">shapes_path</span><span class="si">}</span><span class="s1">/prefecture_shapes.shp'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now have the equivalent shapefiles grouped at the <strong>municipal</strong> and the <strong>prefectural</strong> level, leading to a map of Japan like the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">municipality_shapes</span><span class="p">)</span> 
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">prefecture_shapes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°N'</span><span class="p">),</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°E'</span><span class="p">),</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">129</span><span class="p">,</span> <span class="mf">145.5</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
               <span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
               <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_14_0.png" src="_images/prefecture_weighted_averages_14_0.png"/>

</div>
</div>
</div>
<div class="section" id="fetching-municipalities-populations">
<h3><a class="toc-backref" href="#id6">Fetching municipalities populations</a><a class="headerlink" href="#fetching-municipalities-populations" title="Permalink to this headline">Â¶</a></h3>
<p>The same Statistics portal that we used to fetch the shapefiles provides an API to fetch different variables recorded by the government. It is necessary to register in the system to obtain an identifier that accompanies the requests to the API in order to be granted access. The documentation to use the API can be found <a class="reference external" href="https://www.e-stat.go.jp/api/api-dev/how_to_use">here</a> (itâ€™s all in Japanese but itâ€™s manageable with Google translate).</p>
<p>Weâ€™ll start by defining the API URL preceding the parameters specifying the version of the API we will be using (3.0) and the output we want (json):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">API_URL</span> <span class="o">=</span> <span class="s1">'http://api.e-stat.go.jp/rest/3.0/app/json/getStatsData'</span>
</pre></div>
</div>
</div>
</div>
<p>I have already checked the variables I am interested in, although there are plenty more to choose. We will be fetching the following codes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_api_codes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'A1101'</span><span class="p">:</span> <span class="s1">'Total population (Both sexes)'</span><span class="p">,</span>
                <span class="s1">'A110101'</span><span class="p">:</span> <span class="s1">'Total population (Male)'</span><span class="p">,</span>
                <span class="s1">'A110102'</span><span class="p">:</span> <span class="s1">'Total population (Female)'</span><span class="p">,</span>
                <span class="s1">'A1301'</span><span class="p">:</span> <span class="s1">'Total population (under 15)'</span><span class="p">,</span>
                <span class="s1">'A130101'</span><span class="p">:</span> <span class="s1">'Population (under 15, Male)'</span><span class="p">,</span>
                <span class="s1">'A130102'</span><span class="p">:</span> <span class="s1">'Population (under 15, Female)'</span><span class="p">,</span>
                <span class="s1">'A1302'</span><span class="p">:</span> <span class="s1">'Total population (15-64)'</span><span class="p">,</span>
                <span class="s1">'A130201'</span><span class="p">:</span> <span class="s1">'Population (15-64, Male)'</span><span class="p">,</span>
                <span class="s1">'A130202'</span><span class="p">:</span> <span class="s1">'Population (15-64, Female)'</span><span class="p">,</span>
                <span class="s1">'A1303'</span><span class="p">:</span> <span class="s1">'Total population (65 and over)'</span><span class="p">,</span>
                <span class="s1">'A130301'</span><span class="p">:</span> <span class="s1">'Population (65 and over, Male)'</span><span class="p">,</span>
                <span class="s1">'A130302'</span><span class="p">:</span> <span class="s1">'Population (65 and over, Female)'</span><span class="p">,</span>
                <span class="s1">'A1405'</span><span class="p">:</span> <span class="s1">'Population (0-5, Total)'</span><span class="p">,</span>
                <span class="s1">'A140501'</span><span class="p">:</span> <span class="s1">'Population (0-5, Male)'</span><span class="p">,</span>
                <span class="s1">'A140502'</span><span class="p">:</span> <span class="s1">'Population (0-5, Female)'</span><span class="p">,</span>
                <span class="s1">'A1416'</span><span class="p">:</span> <span class="s1">'Population (60 and over, Total)'</span><span class="p">,</span>
                <span class="s1">'A141601'</span><span class="p">:</span> <span class="s1">'Population (60 and over, Male)'</span><span class="p">,</span>
                <span class="s1">'A141602'</span><span class="p">:</span> <span class="s1">'Population (60 and over, Female)'</span><span class="p">,</span>
                <span class="s1">'A1417'</span><span class="p">:</span> <span class="s1">'Population (70 and over, Total)'</span><span class="p">,</span>
                <span class="s1">'A141701'</span><span class="p">:</span> <span class="s1">'Population (70 and over, Male)'</span><span class="p">,</span>
                <span class="s1">'A141702'</span><span class="p">:</span> <span class="s1">'Population (70 and over, Female)'</span><span class="p">,</span>
                <span class="s1">'A1420'</span><span class="p">:</span> <span class="s1">'Population (85 and over, Total)'</span><span class="p">,</span>
                <span class="s1">'A142001'</span><span class="p">:</span> <span class="s1">'Population (85 and over, Male)'</span><span class="p">,</span>
                <span class="s1">'A142002'</span><span class="p">:</span> <span class="s1">'Population (85 and over, Female)'</span>
               <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>I have saved my personal <code class="docutils literal notranslate"><span class="pre">appID</span></code> in a non-shared file in the root folder as <code class="docutils literal notranslate"><span class="pre">.appID</span></code>. Letâ€™s read it so as to include it in the request URL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'../.appID'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">API_ID</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We need to URL encode all the variables in the requests, which should be done by joining them with the <code class="docutils literal notranslate"><span class="pre">%2C</span></code> characters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variables_string</span> <span class="o">=</span> <span class="s1">'%2C'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">jp_api_codes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>The full request will be the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">API_URL</span><span class="si">}</span><span class="s1">'</span>                       <span class="c1"># Main API URL</span>
       <span class="sa">f</span><span class="s1">'?cdCat01=</span><span class="si">{</span><span class="n">variables_string</span><span class="si">}</span><span class="s1">'</span>     <span class="c1"># Specify the variables selected</span>
       <span class="sa">f</span><span class="s1">'&amp;appId=</span><span class="si">{</span><span class="n">API_ID</span><span class="si">}</span><span class="s1">'</span>                 <span class="c1"># Add the API ID to be allowed access </span>
        <span class="s1">'&amp;lang=E'</span>                         <span class="c1"># Specify the language to be English</span>
        <span class="s1">'&amp;statsDataId=0000020201'</span>         <span class="c1"># Specify the dataset to be used</span>
        <span class="s1">'&amp;cdTimeFrom=2015'</span><span class="p">)</span>               <span class="c1"># Request data from the last census (2015)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">full_population_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                      <span class="p">[</span><span class="s1">'GET_STATS_DATA'</span><span class="p">][</span><span class="s1">'STATISTICAL_DATA'</span><span class="p">][</span><span class="s1">'DATA_INF'</span><span class="p">][</span><span class="s1">'VALUE'</span><span class="p">])</span>
                      <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'@time'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'2015'</span><span class="p">)]</span>
                      <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'@tab'</span><span class="p">,</span> <span class="s1">'@time'</span><span class="p">,</span> <span class="s1">'@unit'</span><span class="p">])</span>
                      <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'@area'</span><span class="p">:</span> <span class="s1">'area_code'</span><span class="p">})</span>
                      <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">'area_code'</span><span class="p">,</span> <span class="s1">'@cat01'</span><span class="p">,</span> <span class="s1">'$'</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">jp_api_codes</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I will keep an already processed version of this dataset in the repository as an easily accessible CSV table to ease future usage of the files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">full_population_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">'../data/population/municipal_population_stats.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">full_population_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/population/municipal_population_stats.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="matching-stations-municipalities-and-populations">
<h2><a class="toc-backref" href="#id7">Matching stations, municipalities, and populations</a><a class="headerlink" href="#matching-stations-municipalities-and-populations" title="Permalink to this headline">Â¶</a></h2>
<p>Since my main interest lies on relating the environmental variables to Kawasaki Disease incidence in Japan, I am going to use the municipal population of children under 5 years old to weight the importance of each municipal term in the prefecture averages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population_variable</span> <span class="o">=</span> <span class="s1">'Population (0-5, Total)'</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_pops</span> <span class="o">=</span> <span class="p">(</span><span class="n">full_population_df</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'area_code'</span><span class="p">:</span> <span class="s1">'code'</span><span class="p">})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">population</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="n">population_variable</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="p">[[</span><span class="s1">'code'</span><span class="p">,</span> <span class="s1">'population'</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_pops_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">full_population_df</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'area_code'</span><span class="p">:</span> <span class="s1">'code'</span><span class="p">})</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">population</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'Total population (Both sexes)'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                <span class="p">[[</span><span class="s1">'code'</span><span class="p">,</span> <span class="s1">'population'</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_munis</span> <span class="o">=</span> <span class="p">(</span><span class="n">municipality_shapes</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">PREF</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">CITY</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
            <span class="p">[[</span><span class="s1">'PREF'</span><span class="p">,</span> <span class="s1">'CITY'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">,</span> <span class="s1">'geometry'</span><span class="p">]]</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_munis</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jp_pops</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">'code'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">'left'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now load the monitoring stations information, and use their coordinates to assign a municipal boundary to each of them. This way, we will be able to average a value for each municipality using the values of the monitoring stations within its boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monitoring_stations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/air_pollution/stations/doc/stations_info.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monitoring_stations</span> <span class="o">=</span> <span class="p">(</span><span class="n">monitoring_stations</span>
                        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]))</span> 
                                                     <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">dd</span><span class="o">.</span><span class="n">latitude</span><span class="p">)])</span>
                        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">'geometry'</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">'EPSG:4612'</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">station_munis</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">monitoring_stations</span><span class="p">,</span> <span class="n">jp_munis</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s1">'within'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jp_munis</span><span class="p">[[</span><span class="s1">'code'</span><span class="p">,</span> <span class="s1">'geometry'</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'geometry'</span><span class="p">:</span> <span class="s1">'m_polygon'</span><span class="p">}))</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stations_per_city</span> <span class="o">=</span> <span class="n">station_munis</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'PREF'</span><span class="p">,</span> <span class="s1">'CITY'</span><span class="p">])</span><span class="o">.</span><span class="n">station_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prefectures_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">monitoring_stations</span>
                    <span class="p">[[</span><span class="s1">'prefecture'</span><span class="p">,</span> <span class="s1">'prefecture_code'</span><span class="p">]]</span>
                    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'prefecture_code'</span><span class="p">)</span>
                    <span class="p">[</span><span class="s1">'prefecture'</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generating-the-daily-averaged-municipal-estimates">
<h2><a class="toc-backref" href="#id8">Generating the daily averaged municipal estimates</a><a class="headerlink" href="#generating-the-daily-averaged-municipal-estimates" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">municipal_pollution_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">pref</span><span class="p">,</span> <span class="n">city</span><span class="p">),</span> <span class="n">stations</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">stations_per_city</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stations_per_city</span><span class="p">)):</span>
    <span class="n">municipal_stations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pref_name</span> <span class="o">=</span> <span class="n">prefectures_map</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pref</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
        <span class="n">municipal_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'../data/air_pollution/stations/clean/</span><span class="si">{</span><span class="n">pref</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">pref_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
        <span class="p">)</span>
    
    <span class="n">municipal_stations</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">municipal_stations</span><span class="p">)</span>
                          <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
                          <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'D'</span><span class="p">)</span>
                          <span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">municipal_pollution_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">municipal_stations</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pref</span><span class="o">=</span><span class="n">pref</span><span class="p">,</span> <span class="n">city</span><span class="o">=</span><span class="n">city</span><span class="p">))</span>
    <span class="n">municipal_stations</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'../data/air_pollution/municipalities/</span><span class="si">{</span><span class="n">pref</span><span class="si">}{</span><span class="n">city</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>
<span class="n">municipal_pollution_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">municipal_pollution_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
</div>
<div class="section" id="generating-the-daily-averaged-prefectural-estimates">
<h2><a class="toc-backref" href="#id9">Generating the daily averaged prefectural estimates</a><a class="headerlink" href="#generating-the-daily-averaged-prefectural-estimates" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">long_pollution_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">municipal_pollution_dfs</span>
                     <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                     <span class="o">.</span><span class="n">melt</span><span class="p">([</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'pref'</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">])</span>
                     <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                     <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'code = pref + city'</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="area-weighted-averages">
<h3><a class="toc-backref" href="#id10">Area-weighted averages</a><a class="headerlink" href="#area-weighted-averages" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_areas</span> <span class="o">=</span> <span class="p">(</span><span class="n">jp_munis</span>
            <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'area = geometry.to_crs("+proj=cea").area / 10**6'</span><span class="p">)</span>
            <span class="p">[[</span><span class="s1">'code'</span><span class="p">,</span> <span class="s1">'area'</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">prefecture</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">long_pollution_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'pref'</span><span class="p">):</span>
    <span class="n">pref_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'variable'</span><span class="p">])</span>
                 <span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span>
                                        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jp_areas</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'weight = area / area.sum()'</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'value = value * weight'</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'value'</span><span class="p">)</span>
<span class="p">)</span>
    <span class="n">pref_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'../data/air_pollution/prefectures/area_weighted/</span><span class="si">{</span><span class="n">prefecture</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="weighting-by-population-of-children-under-5-years-old">
<h3><a class="toc-backref" href="#id11">Weighting by population of children under 5 years old</a><a class="headerlink" href="#weighting-by-population-of-children-under-5-years-old" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">prefecture</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">long_pollution_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'pref'</span><span class="p">):</span>
    <span class="n">pref_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'variable'</span><span class="p">])</span>
                 <span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span>
                                        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jp_pops</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'weight = population / population.sum()'</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'value = value * weight'</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'value'</span><span class="p">)</span>
<span class="p">)</span>
    <span class="n">pref_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'../data/air_pollution/prefectures/under_5_weighted/</span><span class="si">{</span><span class="n">prefecture</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="weighting-by-full-population-density">
<h3><a class="toc-backref" href="#id12">Weighting by full population density</a><a class="headerlink" href="#weighting-by-full-population-density" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">prefecture</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">long_pollution_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'pref'</span><span class="p">):</span>
    <span class="n">pref_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'variable'</span><span class="p">])</span>
                 <span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span>
                                        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jp_pops_full</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'weight = population / population.sum()'</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'value = value * weight'</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'value'</span><span class="p">)</span>
<span class="p">)</span>
    <span class="n">pref_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">'../data/air_pollution/prefectures/population_weighted/</span><span class="si">{</span><span class="n">prefecture</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="visualizing-coverage-of-the-data">
<h2><a class="toc-backref" href="#id13">Visualizing coverage of the data</a><a class="headerlink" href="#visualizing-coverage-of-the-data" title="Permalink to this headline">Â¶</a></h2>
<p>While there are many stations, not all variables are measured with the same consistency. The following table shows how many stations measure each variable in each prefecture:</p>
<div class="section" id="number-of-stations-per-variable-per-prefecture">
<h3><a class="toc-backref" href="#id14">Number of stations per variable per prefecture</a><a class="headerlink" href="#number-of-stations-per-variable-per-prefecture" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">monitoring_stations</span>
 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'station_code'</span><span class="p">,</span> <span class="s1">'latitude'</span><span class="p">,</span> <span class="s1">'longitude'</span><span class="p">,</span> <span class="s1">'altitude'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'prefecture'</span><span class="p">,</span> <span class="s1">'prefecture_code'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
 <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'prefecture_code'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">monitoring_stations</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'prefecture_code'</span><span class="p">)</span><span class="o">.</span><span class="n">station_code</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
 <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">melt</span><span class="p">([</span><span class="s1">'prefecture'</span><span class="p">,</span> <span class="s1">'prefecture_code'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'not variable.isin(["NO", "NO2", "CH4", "NMHC"])'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'NOX'</span><span class="p">:</span> <span class="s1">'NO$_</span><span class="si">{x}</span><span class="s1">$'</span><span class="p">,</span> <span class="s1">'PM25'</span><span class="p">:</span> <span class="s1">'PM$_</span><span class="si">{2.5}</span><span class="s1">$'</span><span class="p">,</span> <span class="s1">'SO2'</span><span class="p">:</span> <span class="s1">'SO$_2$'</span><span class="p">,</span> <span class="s1">'CO2'</span><span class="p">:</span> <span class="s1">'CO$_2$'</span><span class="p">})</span>
<span class="c1">#  .append(monitoring_stations.groupby('prefecture').size().rename('value').reset_index().assign(variable='Total (n)'))</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'reorder(variable, value, ascending=True)'</span><span class="p">,</span> <span class="s1">'reorder(prefecture.str.split("-").str[0], value, ascending=False)'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">'value'</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_tile</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_text</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">'value.round(0).astype(int).astype(str) + ""'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'value &gt; 70'</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>      
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_minimal</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">'black'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_continuous</span><span class="p">(</span><span class="s1">'Oranges'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Percentage of stations collecting data'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">coord_flip</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
                           <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                           <span class="n">axis_text_x</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="p">{</span><span class="s1">'t'</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">}),</span>
                           <span class="n">axis_text_y</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'right'</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="p">{</span><span class="s1">'r'</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">}),</span>
                           <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>
<span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_59_0.png" src="_images/prefecture_weighted_averages_59_0.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">monitoring_stations</span>
 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'station_code'</span><span class="p">,</span> <span class="s1">'latitude'</span><span class="p">,</span> <span class="s1">'longitude'</span><span class="p">,</span> <span class="s1">'altitude'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'prefecture'</span><span class="p">,</span> <span class="s1">'prefecture_code'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
 <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">monitoring_stations</span><span class="o">.</span><span class="n">station_code</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">'ratio'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'not index.isin(["NO", "NO2", "CH4", "NMHC"])'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'NOX'</span><span class="p">:</span> <span class="s1">'NO$_</span><span class="si">{x}</span><span class="s1">$'</span><span class="p">,</span> <span class="s1">'PM25'</span><span class="p">:</span> <span class="s1">'PM$_</span><span class="si">{2.5}</span><span class="s1">$'</span><span class="p">,</span> <span class="s1">'SO2'</span><span class="p">:</span> <span class="s1">'SO$_2$'</span><span class="p">,</span> <span class="s1">'CO2'</span><span class="p">:</span> <span class="s1">'CO$_2$'</span><span class="p">})</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'reorder(index, ratio)'</span><span class="p">,</span> <span class="s1">'ratio'</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_col</span><span class="p">()</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">coord_flip</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">percent_format</span><span class="p">())</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
                           <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>
 <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_60_0.png" src="_images/prefecture_weighted_averages_60_0.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_munis</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">has_station</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">station_munis</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pop_coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">jp_munis</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'PREF'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'has_station'</span><span class="p">)</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">dd</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">'pop_coverage'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'PREF'</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The prefecture of Tokyo has many small islands (barely inhabited) which distort completely the shape of the region. Letâ€™s get ride of those for the plots:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_munis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">jp_munis</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"PREF!='13'"</span><span class="p">),</span>
                      <span class="n">jp_munis</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"PREF=='13'"</span><span class="p">)</span>
                              <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'geometry.bounds.miny &gt; 35'</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_munis</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jp_pops_full</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jp_munis</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'PREF'</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">relative_weight</span><span class="o">=</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">population</span> <span class="o">/</span> <span class="n">dd</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">())))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">jp_munis</span><span class="p">)</span> 
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">'population'</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mf">.01</span><span class="p">)</span> 
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">prefecture_shapes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># + p9.geom_point(p9.aes(x='longitude', y='latitude'), data=monitoring_stations, size=.3, stroke=0, alpha=.7, color='lime')</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_continuous</span><span class="p">(</span><span class="s1">'Oranges'</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°N'</span><span class="p">),</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°E'</span><span class="p">),</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">129</span><span class="p">,</span> <span class="mf">145.5</span><span class="p">))</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_void</span><span class="p">()</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/prefecture_weighted_averages_68_0.png" src="_images/prefecture_weighted_averages_68_0.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">jp_munis</span><span class="p">)</span> 
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">'white'</span><span class="p">)</span> 
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">prefecture_shapes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'longitude'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'latitude'</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">monitoring_stations</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">129</span><span class="p">,</span> <span class="mf">145.5</span><span class="p">))</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_void</span><span class="p">()</span>
<span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

<span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../data/air_pollution/stations/doc/stations_map.png'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">48</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">'PREF=="</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="n">monitoring_stations</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">'prefecture_code==</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">prefecture_name</span> <span class="o">=</span> <span class="n">prefectures_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">pop_coverage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">'min'</span><span class="p">,</span> <span class="s1">'max'</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">'population'</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'longitude'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'latitude'</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">'N. of children &lt;5'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_continuous</span><span class="p">(</span><span class="s1">'Oranges'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°E'</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°N'</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggtitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">prefecture_name</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coverage</span><span class="si">}</span><span class="s1">% population covered'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span>
                           <span class="n">aspect_ratio</span><span class="o">=</span><span class="n">ar</span><span class="p">,</span>
                           <span class="n">legend_key_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
                           <span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                           <span class="n">legend_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                           <span class="n">legend_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'baseline'</span><span class="p">))</span>

 <span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/prefecture_weighted_averages_70_1.png" src="_images/prefecture_weighted_averages_70_1.png"/>
<img alt="_images/prefecture_weighted_averages_70_2.png" src="_images/prefecture_weighted_averages_70_2.png"/>
<img alt="_images/prefecture_weighted_averages_70_3.png" src="_images/prefecture_weighted_averages_70_3.png"/>
<img alt="_images/prefecture_weighted_averages_70_4.png" src="_images/prefecture_weighted_averages_70_4.png"/>
<img alt="_images/prefecture_weighted_averages_70_5.png" src="_images/prefecture_weighted_averages_70_5.png"/>
<img alt="_images/prefecture_weighted_averages_70_6.png" src="_images/prefecture_weighted_averages_70_6.png"/>
<img alt="_images/prefecture_weighted_averages_70_7.png" src="_images/prefecture_weighted_averages_70_7.png"/>
<img alt="_images/prefecture_weighted_averages_70_8.png" src="_images/prefecture_weighted_averages_70_8.png"/>
<img alt="_images/prefecture_weighted_averages_70_9.png" src="_images/prefecture_weighted_averages_70_9.png"/>
<img alt="_images/prefecture_weighted_averages_70_10.png" src="_images/prefecture_weighted_averages_70_10.png"/>
<img alt="_images/prefecture_weighted_averages_70_11.png" src="_images/prefecture_weighted_averages_70_11.png"/>
<img alt="_images/prefecture_weighted_averages_70_12.png" src="_images/prefecture_weighted_averages_70_12.png"/>
<img alt="_images/prefecture_weighted_averages_70_13.png" src="_images/prefecture_weighted_averages_70_13.png"/>
<img alt="_images/prefecture_weighted_averages_70_14.png" src="_images/prefecture_weighted_averages_70_14.png"/>
<img alt="_images/prefecture_weighted_averages_70_15.png" src="_images/prefecture_weighted_averages_70_15.png"/>
<img alt="_images/prefecture_weighted_averages_70_16.png" src="_images/prefecture_weighted_averages_70_16.png"/>
<img alt="_images/prefecture_weighted_averages_70_17.png" src="_images/prefecture_weighted_averages_70_17.png"/>
<img alt="_images/prefecture_weighted_averages_70_18.png" src="_images/prefecture_weighted_averages_70_18.png"/>
<img alt="_images/prefecture_weighted_averages_70_19.png" src="_images/prefecture_weighted_averages_70_19.png"/>
<img alt="_images/prefecture_weighted_averages_70_20.png" src="_images/prefecture_weighted_averages_70_20.png"/>
<img alt="_images/prefecture_weighted_averages_70_21.png" src="_images/prefecture_weighted_averages_70_21.png"/>
<img alt="_images/prefecture_weighted_averages_70_22.png" src="_images/prefecture_weighted_averages_70_22.png"/>
<img alt="_images/prefecture_weighted_averages_70_23.png" src="_images/prefecture_weighted_averages_70_23.png"/>
<img alt="_images/prefecture_weighted_averages_70_24.png" src="_images/prefecture_weighted_averages_70_24.png"/>
<img alt="_images/prefecture_weighted_averages_70_25.png" src="_images/prefecture_weighted_averages_70_25.png"/>
<img alt="_images/prefecture_weighted_averages_70_26.png" src="_images/prefecture_weighted_averages_70_26.png"/>
<img alt="_images/prefecture_weighted_averages_70_27.png" src="_images/prefecture_weighted_averages_70_27.png"/>
<img alt="_images/prefecture_weighted_averages_70_28.png" src="_images/prefecture_weighted_averages_70_28.png"/>
<img alt="_images/prefecture_weighted_averages_70_29.png" src="_images/prefecture_weighted_averages_70_29.png"/>
<img alt="_images/prefecture_weighted_averages_70_30.png" src="_images/prefecture_weighted_averages_70_30.png"/>
<img alt="_images/prefecture_weighted_averages_70_31.png" src="_images/prefecture_weighted_averages_70_31.png"/>
<img alt="_images/prefecture_weighted_averages_70_32.png" src="_images/prefecture_weighted_averages_70_32.png"/>
<img alt="_images/prefecture_weighted_averages_70_33.png" src="_images/prefecture_weighted_averages_70_33.png"/>
<img alt="_images/prefecture_weighted_averages_70_34.png" src="_images/prefecture_weighted_averages_70_34.png"/>
<img alt="_images/prefecture_weighted_averages_70_35.png" src="_images/prefecture_weighted_averages_70_35.png"/>
<img alt="_images/prefecture_weighted_averages_70_36.png" src="_images/prefecture_weighted_averages_70_36.png"/>
<img alt="_images/prefecture_weighted_averages_70_37.png" src="_images/prefecture_weighted_averages_70_37.png"/>
<img alt="_images/prefecture_weighted_averages_70_38.png" src="_images/prefecture_weighted_averages_70_38.png"/>
<img alt="_images/prefecture_weighted_averages_70_39.png" src="_images/prefecture_weighted_averages_70_39.png"/>
<img alt="_images/prefecture_weighted_averages_70_40.png" src="_images/prefecture_weighted_averages_70_40.png"/>
<img alt="_images/prefecture_weighted_averages_70_41.png" src="_images/prefecture_weighted_averages_70_41.png"/>
<img alt="_images/prefecture_weighted_averages_70_42.png" src="_images/prefecture_weighted_averages_70_42.png"/>
<img alt="_images/prefecture_weighted_averages_70_43.png" src="_images/prefecture_weighted_averages_70_43.png"/>
<img alt="_images/prefecture_weighted_averages_70_44.png" src="_images/prefecture_weighted_averages_70_44.png"/>
<img alt="_images/prefecture_weighted_averages_70_45.png" src="_images/prefecture_weighted_averages_70_45.png"/>
<img alt="_images/prefecture_weighted_averages_70_46.png" src="_images/prefecture_weighted_averages_70_46.png"/>
<img alt="_images/prefecture_weighted_averages_70_47.png" src="_images/prefecture_weighted_averages_70_47.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">48</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">'PREF=="</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="n">monitoring_stations</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">'prefecture_code==</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">stats_df</span><span class="p">[</span><span class="s1">'prefecture'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefectures_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">stats_df</span><span class="p">[</span><span class="s1">'prefecture_code'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">stats_df</span><span class="p">[</span><span class="s1">'n_stations'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">))</span>
    <span class="n">stats_df</span><span class="p">[</span><span class="s1">'coverage'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pop_coverage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">'min'</span><span class="p">,</span> <span class="s1">'max'</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
    <span class="n">stats_df</span><span class="p">[</span><span class="s1">'ar'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_rc_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'text.usetex'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="s2">"svg.fonttype"</span><span class="p">:</span> <span class="s1">'none'</span>
<span class="p">}</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_rc_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'ar'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prefecture</th>
      <th>prefecture_code</th>
      <th>n_stations</th>
      <th>coverage</th>
      <th>ar</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>30</th>
      <td>Tottori</td>
      <td>31</td>
      <td>7</td>
      <td>78.08</td>
      <td>0.403184</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Tokyo</td>
      <td>13</td>
      <td>90</td>
      <td>95.49</td>
      <td>0.406036</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Saitama</td>
      <td>11</td>
      <td>88</td>
      <td>86.40</td>
      <td>0.445775</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Okinawa</td>
      <td>47</td>
      <td>9</td>
      <td>59.75</td>
      <td>0.457206</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Kagawa</td>
      <td>37</td>
      <td>25</td>
      <td>83.26</td>
      <td>0.551765</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Kanagawa</td>
      <td>14</td>
      <td>97</td>
      <td>98.29</td>
      <td>0.593274</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Aomori</td>
      <td>2</td>
      <td>19</td>
      <td>76.25</td>
      <td>0.612204</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Tokushima</td>
      <td>36</td>
      <td>24</td>
      <td>84.49</td>
      <td>0.613693</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Shizuoka</td>
      <td>22</td>
      <td>66</td>
      <td>87.24</td>
      <td>0.630008</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Fukushima</td>
      <td>7</td>
      <td>48</td>
      <td>80.42</td>
      <td>0.630304</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Yamaguchi</td>
      <td>35</td>
      <td>36</td>
      <td>97.44</td>
      <td>0.632200</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Hokkai</td>
      <td>1</td>
      <td>100</td>
      <td>73.04</td>
      <td>0.643148</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Kochi</td>
      <td>39</td>
      <td>10</td>
      <td>67.01</td>
      <td>0.643891</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Fukui</td>
      <td>18</td>
      <td>31</td>
      <td>87.77</td>
      <td>0.689012</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Toyama</td>
      <td>16</td>
      <td>27</td>
      <td>94.96</td>
      <td>0.709683</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Aichi</td>
      <td>23</td>
      <td>126</td>
      <td>91.06</td>
      <td>0.725509</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Hiroshima</td>
      <td>34</td>
      <td>41</td>
      <td>85.23</td>
      <td>0.747246</td>
    </tr>
    <tr>
      <th>43</th>
      <td>Oita</td>
      <td>44</td>
      <td>27</td>
      <td>88.10</td>
      <td>0.758186</td>
    </tr>
    <tr>
      <th>42</th>
      <td>Kumamoto</td>
      <td>43</td>
      <td>43</td>
      <td>79.35</td>
      <td>0.791667</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Niigata</td>
      <td>15</td>
      <td>30</td>
      <td>79.60</td>
      <td>0.802225</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Saga</td>
      <td>41</td>
      <td>19</td>
      <td>82.95</td>
      <td>0.829702</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Ehime</td>
      <td>38</td>
      <td>34</td>
      <td>87.44</td>
      <td>0.835476</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Yamanashi</td>
      <td>19</td>
      <td>12</td>
      <td>62.04</td>
      <td>0.841971</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Gunma</td>
      <td>10</td>
      <td>31</td>
      <td>84.28</td>
      <td>0.843597</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Miyagi</td>
      <td>4</td>
      <td>39</td>
      <td>87.70</td>
      <td>0.877691</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Kyoto</td>
      <td>26</td>
      <td>41</td>
      <td>86.10</td>
      <td>0.893146</td>
    </tr>
    <tr>
      <th>32</th>
      <td>Okayama</td>
      <td>33</td>
      <td>68</td>
      <td>92.55</td>
      <td>0.919506</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Wakayama</td>
      <td>30</td>
      <td>41</td>
      <td>79.73</td>
      <td>0.937257</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Gifu</td>
      <td>21</td>
      <td>23</td>
      <td>72.76</td>
      <td>0.960218</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Tochigi</td>
      <td>9</td>
      <td>37</td>
      <td>90.83</td>
      <td>0.988446</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Ibaraki</td>
      <td>8</td>
      <td>53</td>
      <td>83.09</td>
      <td>1.037559</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Chiba</td>
      <td>12</td>
      <td>145</td>
      <td>93.99</td>
      <td>1.075928</td>
    </tr>
    <tr>
      <th>39</th>
      <td>Fukuoka</td>
      <td>40</td>
      <td>64</td>
      <td>74.31</td>
      <td>1.082189</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Osaka</td>
      <td>27</td>
      <td>108</td>
      <td>89.44</td>
      <td>1.190048</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Iwate</td>
      <td>3</td>
      <td>15</td>
      <td>82.07</td>
      <td>1.199794</td>
    </tr>
    <tr>
      <th>41</th>
      <td>Nagasaki</td>
      <td>42</td>
      <td>24</td>
      <td>87.13</td>
      <td>1.200404</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Hyogo</td>
      <td>28</td>
      <td>109</td>
      <td>91.27</td>
      <td>1.249549</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Miyazaki</td>
      <td>45</td>
      <td>26</td>
      <td>81.48</td>
      <td>1.250401</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Akita</td>
      <td>5</td>
      <td>21</td>
      <td>77.09</td>
      <td>1.257724</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Nagano</td>
      <td>20</td>
      <td>23</td>
      <td>65.18</td>
      <td>1.294842</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Yamagata</td>
      <td>6</td>
      <td>18</td>
      <td>75.10</td>
      <td>1.315624</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Shiga</td>
      <td>25</td>
      <td>17</td>
      <td>78.30</td>
      <td>1.320532</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Nara</td>
      <td>29</td>
      <td>16</td>
      <td>65.08</td>
      <td>1.335929</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Mie</td>
      <td>24</td>
      <td>35</td>
      <td>92.86</td>
      <td>1.352448</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Ishikawa</td>
      <td>17</td>
      <td>29</td>
      <td>93.76</td>
      <td>1.599412</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Shimane</td>
      <td>32</td>
      <td>10</td>
      <td>91.47</td>
      <td>1.712067</td>
    </tr>
    <tr>
      <th>45</th>
      <td>Kagoshima</td>
      <td>46</td>
      <td>19</td>
      <td>68.57</td>
      <td>1.883288</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'ar'</span><span class="p">)</span><span class="o">.</span><span class="n">prefecture_code</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">jp_munis</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">'PREF=="</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="n">monitoring_stations</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">'prefecture_code==</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">n_stations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
    <span class="n">prefecture_name</span> <span class="o">=</span> <span class="n">prefectures_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">pop_coverage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">'min'</span><span class="p">,</span> <span class="s1">'max'</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_map</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">'population'</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mf">.02</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'longitude'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'latitude'</span><span class="p">),</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_continuous</span><span class="p">(</span><span class="s1">'Oranges'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°E'</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">custom_format</span><span class="p">(</span><span class="s1">'</span><span class="si">{:0g}</span><span class="s1">Â°N'</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggtitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">prefecture_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">n_stations</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coverage</span><span class="si">}</span><span class="s1">%)'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_void</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="o">=</span><span class="n">ar</span><span class="p">,</span>
                           <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">),)</span>

 <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">'../data/doc/images/</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">prefecture_name</span><span class="si">}</span><span class="s1">.pdf'</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 47/47 [00:27&lt;00:00,  1.74it/s]
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class="prev-next-area"> 
    <a class="left-prev" href="index.html" id="prev-link" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Japanâ€™s environmental Data</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Alejandro Fontal<br/>
    
        Â© Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  
</body></html>